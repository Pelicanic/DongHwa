
## ê°œë°œ ì´ìŠˆ

| ë¬¸ì œ           | ì„¤ëª…                                                                   |
| ------------ | -------------------------------------------------------------------- |
| âœ… ì„ íƒì§€ ìœ ë„ ë¬¸ì œ  | ì‚¬ìš©ìì˜ ì…ë ¥ ë˜ëŠ” ì„ íƒì§€ë¥¼ ê¸°ìŠ¹ì „ê²°ì˜ **ê²°ë§ ìª½ìœ¼ë¡œ ìœ ë„**í•  ìˆ˜ ìˆë„ë¡ ì„¤ê³„ í•„ìš”                     |
| âœ… ê²°ë§ ì•ˆì •ì„±     | ê²°ë§ì€ **ê¸°ì¡´ íë¦„ì„ ìœ ì§€**í•˜ë©° ë³€í™”í•˜ì§€ ì•Šë„ë¡ ìœ ë„í•´ì•¼ í•¨                                  |
| âœ… ì¤‘ê°„ íë¦„ ìœ ì—°ì„±  | ì‚¬ìš©ì ì…ë ¥ì— ë”°ë¼ **ê¸°/ìŠ¹/ì „** íë¦„ì€ ì¼ë¶€ ë³€ë™ ê°€ëŠ¥í•˜ì§€ë§Œ, ì „ì²´ íë¦„ì€ **10ë¬¸ë‹¨ ì´ë‚´ ì¢…ë£Œ**ë˜ë„ë¡ ì œì•½ í•„ìš” |
| âœ… ì¸ë¬¼ ë°˜ì˜ ë¬¸ì œ   | `Story.characters`ì—ëŠ” **ì‹¤ì œ ìŠ¤í† ë¦¬ ë¬¸ë‹¨ì— ë“±ì¥í•œ ì¸ë¬¼ë§Œ ë°˜ì˜**ë˜ì–´ì•¼ í•¨                  |
| âœ… ìŠ¤ì³ê°€ëŠ” ì¸ë¬¼ ë¬¸ì œ | **ì¤‘ê°„ì— ì ê¹ ë“±ì¥í•œ ì¸ë¬¼ë“¤ì´ ê²°ë§ê¹Œì§€ í¬í•¨ë˜ëŠ” ë¬¸ì œ** ë°œìƒ â†’ ì¸ë¬¼ í•„í„°ë§ ê¸°ì¤€ ê°•í™” í•„ìš”                |
| âœ… ê²°ë§ í›„ ì •ë¦¬ ë¶€ì¡± | ë§ˆì§€ë§‰ ë¬¸ë‹¨ ì´í›„ **ì •ì„œì /ì„œì‚¬ì  ë§ˆë¬´ë¦¬** ë¶€ì¡±                                         |
| âœ… QA ì§ˆë¬¸ ì»¬ëŸ¼   | QA í…Œì´ë¸”ì— AI ì§ˆë¬¸ ì»¬ëŸ¼ì´ ì—†ë˜ ë¬¸ì œ â†’ **ì»¬ëŸ¼ ë° ì‚½ì… ë¡œì§ ì¶”ê°€ ì™„ë£Œ**                       |


## ìµœì í™” ì´ìŠˆ

### âœ… Gemini API ê³¼ë‹¤ í˜¸ì¶œ
- ê¸°ì¡´: ë¬¸ë‹¨ ìƒì„± 1íšŒë‹¹ ìµœëŒ€ **9íšŒ API í˜¸ì¶œ**
- ì¡°ì¹˜: `extract_and_describe()` í†µí•©ìœ¼ë¡œ ìµœì í™”
    

### âœ… N+1 DB ì¿¼ë¦¬
- ë¬¸ì œ: `Story.objects.get()` ë°˜ë³µ, insert ë°˜ë³µ
- ì¡°ì¹˜: `bulk_create`, `state ìºì‹±`ìœ¼ë¡œ **DB ì ‘ê·¼ ìµœì†Œí™”**
    

### âœ… ë¬¸ìì—´ ìœ ì‚¬ë„ ë³‘ëª©
- ë¬¸ì œ: `difflib`ì˜ `SequenceMatcher` ì„±ëŠ¥ ì €í•˜
- ëŒ€ì•ˆ: `rapidfuzz`ë‚˜ ìœ ì‚¬ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ êµì²´ ê³ ë ¤
    

---



## ê°œì„  ìš°ì„ ìˆœìœ„

|ìš°ì„ ìˆœìœ„|ê°œì„  í•­ëª©|ì¤‘ìš”ë„|ë‚œì´ë„|ì˜ˆìƒ íš¨ê³¼|ìƒì„¸ ì„¤ëª…|
|---|---|---|---|---|---|
|ğŸš¨ **1ìˆœìœ„**|**Gemini API í†µí•© í˜¸ì¶œ**|â˜…â˜…â˜…â˜…â˜…|â˜…â˜…â˜…â˜†â˜†|**40-50% ì†ë„ í–¥ìƒ**|ìºë¦­í„° ê´€ë ¨ 3ê°œ í•¨ìˆ˜ë¥¼ 1ê°œë¡œ í†µí•©|
|ğŸš¨ **1ìˆœìœ„**|**bulk_create ì „í™˜**|â˜…â˜…â˜…â˜…â˜…|â˜…â˜†â˜†â˜†â˜†|**2-3ë°° DB ì„±ëŠ¥ í–¥ìƒ**|finalize_story_output ë“± ìˆœì°¨ ì €ì¥ â†’ ì¼ê´„ ì €ì¥|
|ğŸ”¥ **2ìˆœìœ„**|**ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ ë³‘í•©**|â˜…â˜…â˜…â˜…â˜†|â˜…â˜…â˜†â˜†â˜†|**ì´ë¯¸ì§€ ìƒì„± 50% ë‹¨ì¶•**|2ë‹¨ê³„ í˜¸ì¶œ â†’ 1ë‹¨ê³„ í˜¸ì¶œ|
|ğŸ”¥ **2ìˆœìœ„**|**Story ê°ì²´ ìºì‹±**|â˜…â˜…â˜…â˜…â˜†|â˜…â˜†â˜†â˜†â˜†|**ì¤‘ë³µ DB ì¡°íšŒ ì œê±°**|stateì— story ê°ì²´ ì €ì¥ í›„ ì¬ì‚¬ìš©|
|âš ï¸ **3ìˆœìœ„**|**ë¬¸ìì—´ ìœ ì‚¬ë„ ìµœì í™”**|â˜…â˜…â˜…â˜†â˜†|â˜…â˜…â˜†â˜†â˜†|**ìºë¦­í„° ì²˜ë¦¬ 30% í–¥ìƒ**|rapidfuzzë¡œ êµì²´ ë˜ëŠ” pre-indexing|




## ğŸ’¡ **êµ¬ì²´ì  êµ¬í˜„ ë°©ì•ˆ**

### ğŸš¨ 1ìˆœìœ„: Gemini API í†µí•© í˜¸ì¶œ

```python
# í˜„ì¬: 3ë²ˆ ë¶„ë¦¬ í˜¸ì¶œ
filter_significant_characters()  # 1íšŒ
extract_new_characters()         # 2íšŒ  
get_character_description()      # 3íšŒ

# ê°œì„ : 1ë²ˆ í†µí•© í˜¸ì¶œ
def extract_and_describe(text: str, user_input: str, known_names: list, age: int) -> dict:
    prompt = """
    ë‹¤ìŒ ë¬¸ë‹¨ì—ì„œ ìƒˆë¡­ê²Œ ë“±ì¥í•˜ëŠ” ì˜ë¯¸ìˆëŠ” ì¸ë¬¼ë§Œ ì¶”ì¶œí•˜ê³  í”„ë¡œí•„ì„ ì‘ì„±í•˜ì„¸ìš”.
    
    ì¶œë ¥ í˜•ì‹:
    {
        "new_characters": [
            {"name": "ë­‰ì¹˜", "description": "ìˆ˜ì»·, ê°ˆìƒ‰ í„¸, ê²€ì€ ëˆˆë™ì, 3ì„¸, ê°•ì•„ì§€"},
            {"name": "í¬ì½”", "description": "ìˆ˜ì»·, íŒŒë€ í„¸, ì´ˆë¡ ëˆˆ, 4ì„¸, ê³ ì–‘ì´"}
        ]
    }
    """
    # 1íšŒ í˜¸ì¶œë¡œ ëª¨ë“  ìºë¦­í„° ì •ë³´ íšë“
```

### ğŸš¨ 1ìˆœìœ„: bulk_create ì „í™˜
```python
# í˜„ì¬: finalize_utils.py
for i, para in enumerate(new_paragraphs):
    Storyparagraph.objects.create(...)  # 10íšŒ ê°œë³„ í˜¸ì¶œ

# ê°œì„ :
paragraphs_to_create = [
    Storyparagraph(story_id=story_id, paragraph_no=next_para_no + i, content_text=para.strip())
    for i, para in enumerate(new_paragraphs)
]
Storyparagraph.objects.bulk_create(paragraphs_to_create)  # 1íšŒ ì¼ê´„ ìƒì„±
```

### ğŸ”¥ 2ìˆœìœ„: ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸ ë³‘í•©

```python
# í˜„ì¬: node_img.py
analysis_chain = analysis_prompt | model    # 1íšŒ í˜¸ì¶œ
image_chain = image_prompt | model          # 2íšŒ í˜¸ì¶œ

# ê°œì„ : ë‹¨ì¼ í†µí•© í”„ë¡¬í”„íŠ¸
unified_prompt = """
ë‹¤ìŒ ë¬¸ë‹¨ì„ ë°”íƒ•ìœ¼ë¡œ Stable Diffusionìš© ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ JSON í˜•íƒœë¡œ ì‘ì„±í•˜ì„¸ìš”.
ë¶„ì„ ê³¼ì •ì€ ìƒëµí•˜ê³  ìµœì¢… ê²°ê³¼ë§Œ ì¶œë ¥í•˜ì„¸ìš”.

[ì¶œë ¥ í˜•ì‹]
{
    "caption_text": "í•œê¸€ ì„¤ëª…",
    "labels": ["ë¼ë²¨1", "ë¼ë²¨2"], 
    "positive_prompt": "Stable Diffusion í”„ë¡¬í”„íŠ¸"
}
"""
# 1íšŒ í˜¸ì¶œë¡œ ëª¨ë“  ì´ë¯¸ì§€ ì •ë³´ ìƒì„±
```

### ğŸ”¥ 2ìˆœìœ„: Story ê°ì²´ ìºì‹±

```python
# í˜„ì¬: ê° í•¨ìˆ˜ë§ˆë‹¤ ê°œë³„ ì¡°íšŒ
def generate_story_plan(state):
    story = Story.objects.get(story_id=story_id)  # 1íšŒ

def detect_and_update_story(state):
    story = Story.objects.get(story_id=story_id)  # 2íšŒ

# ê°œì„ : stateì— ë¯¸ë¦¬ ì €ì¥
def passthrough_start(state):
    story = Story.objects.get(story_id=state["story_id"])
    return {**state, "story": story}  # ëª¨ë“  ë…¸ë“œì—ì„œ ì¬ì‚¬ìš©
```

<br>


## ğŸ§ª êµ¬í˜„ìƒ ê°œì„  ìš°ì„ ìˆœìœ„

|ìš°ì„ ìˆœìœ„|ê°œì„  í•­ëª©|íš¨ê³¼|ìƒíƒœ|
|---|---|---|---|
|ğŸš¨ 1ìˆœìœ„|Gemini API í†µí•© í˜¸ì¶œ|ìµœëŒ€ 50% ì†ë„ í–¥ìƒ|âœ… ì™„ë£Œ|
|ğŸš¨ 1ìˆœìœ„|`bulk_create` ì €ì¥ ë°©ì‹|DB ì„±ëŠ¥ 2~3ë°° í–¥ìƒ|âœ… ì™„ë£Œ|
|ğŸ”¥ 2ìˆœìœ„|ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ë³‘í•©|ìƒì„± ì‹œê°„ 50% ë‹¨ì¶•|âœ… ì™„ë£Œ|
|ğŸ”¥ 2ìˆœìœ„|Story ê°ì²´ ìºì‹±|ì¤‘ë³µ DB ì ‘ê·¼ ì œê±°|âœ… ì™„ë£Œ|
|âš ï¸ 3ìˆœìœ„|ë¬¸ìì—´ ìœ ì‚¬ë„ ìµœì í™”|ìºë¦­í„° ì²˜ë¦¬ 30% í–¥ìƒ|ì§„í–‰ ì˜ˆì •|

---

| ìµœì í™” í•­ëª©             | ê°œì„  íš¨ê³¼         | ìƒíƒœ       |
| ------------------ | ------------- | -------- |
| **bulk_create ì „í™˜** | DB ì²˜ë¦¬ 2-3ë°° í–¥ìƒ | âœ… **ì™„ë£Œ** |
| **Story ê°ì²´ ìºì‹±**    | DB ì¡°íšŒ 75% ê°ì†Œ  | âœ… **ì™„ë£Œ** |
| **Gemini API í†µí•©**  | API í˜¸ì¶œ 66% ê°ì†Œ | âœ… **ì™„ë£Œ** |
| **ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ ë³‘í•©**    | ì´ë¯¸ì§€ ìƒì„± 50% ë‹¨ì¶• | âœ… **ì™„ë£Œ** |
