### 이미 해결하거나 개선된 사항
#### 1. 문체 변화 문제 (~했다)
- `generate_paragraph`의 프롬프트에서 다음을 명시:
    - `"DO NOT use ~았다/~었다/~했다 ANYWHERE"`
    - `"End every sentence with ~해요/~어요/~답니다"`    
- 톤 유지를 위한 `system_instruction`에서 `picture book tone`, `age-appropriate`, `gentle` 강조

<br>

#### 2. 동화 마무리 실패 문제
- `get_force_final_ending_instruction()` 도입하여 `paragraph_no == 10`일 때 강제로 마무리 유도
- `"DO NOT write [질문] or [행동]"`, `"clear final sentence that signals story has ended"` 등의 지시 포함
- `paragraph_hint`, `substage_instruction`에 `"결2"`와 `"에필로그"`에 대한 마무리 강조 추가
    
<br>

#### 3. `[질문]/[행동]`이 문단 내용과 연관 없거나 과도한 문제
- `get_substage_instruction()`에 따라 각 단계별로 자연스러운 행동만 유도
- `generate_paragraph()` 프롬프트 내에서 `[행동]은 반드시 현재 substage 전개와 연결되어야 한다`는 지침 명시
- `paragraph_hint`, `Stage Summary`, `Next Summary`, `context`를 prompt 중간에 배치해 연결성 강화
    

---

### ⚙️ 점진적으로 해결 중이거나 작업 중인 사항

#### 1. 전체 프롬프트 과밀/중복 문제
- 최근 변경점:
    - `instruction_suffix` 도입해 paragraph_no 기준 조건 분기
    - `Stage Summary`, `Next Stage`, `paragraph_hint`, `substage_instruction` 등의 위치를 일관성 있게 재배치
- 앞으로 할 일:
    - 중복 지시사항은 별도 템플릿화 후 함수로 분리
    - 주요 규칙(말투, 문장 수, 선택지 조건)은 표 형식으로 간결하게 재정리
        

---

### 🔧 06-18일 다음에 적용할 수 있는 CoT 

| **문제 항목**            | **설명**                                | **비고 / 대응 방식**                                       |
| -------------------- | ------------------------------------- | ---------------------------------------------------- |
| 문단 내용과 무관한 질문/선택지 생성 | [문장]과 무관한 질문, 스토리 흐름과 맞지 않는 행동 선택지 생성 | CoT를 통해 질문/선택지 생성 전 **문단 핵심 요약 및 연결성 유도**            |
| 동화가 자연스럽게 마무리되지 않음   | 10문단 이후에도 **결말이 모호**하거나 갑자기 끊김        | "지금까지 사건 정리 → 감정 정리 → 결말 유도" CoT 단계 삽입               |
| story_plan의 흐름이 급변함  | detect_and_update_story가 흐름을 과도하게 뒤바꿈 | CoT로 **현재 요약 흐름 내 변화 가능한 범위 인식 유도**, 단 프롬프트 제약 병행 필요 |
| 등장인물 무분별 확장          | 요정, 두더지, 정령 등 **기획되지 않은 인물 무단 생성**    | "기존 등장인물 재활용 가능한가?" CoT 질문 가능하나, **명시적 등장인물 제한**이 우선 |

<br>

| CoT 적용 우선도 | 적용 대상                             | 기대 효과                       |
| ---------- | --------------------------------- | --------------------------- |
| 1단계        | [문장] → [질문]/[행동] 연결               | 논리적 맥락 강화, 선택지의 자연스러운 전개 유도 |
| 2단계        | 10번째 문단 종료 (에필로그)                 | 감정 정리 + 서사 종료 유도, 열린 결말 방지  |
| 3단계        | detect_and_update_story 흐름 안정화 유도 | 유저 입력 반영하되 전체 흐름 급변 방지      |


### 단순 프롬프트 기반 Zero-shot CoT 예시
```python
reasoning_instruction = "Before writing the paragraph, think step-by-step:"
reasoning_prompt = (
    "1. What just happened in the story?"
    "2. How would the character logically feel now?"
    "3. What event could naturally happen next, based on the child's input?"
    "4. What emotional tone fits best?"
)
# → GPT가 답변 전에 스스로 논리적 흐름을 정리하도록 유도하는 구조



...


f"{reasoning_instruction}\n{reasoning_prompt}\n\n"
f"Then write:\n"
# → 사고 흐름을 먼저 ‘생각한 후’, 문단을 쓰라는 단계 명령

```



<br>

### CoT 이후 적용 가능한 개선 전략(간단 예시, GPT 발췌)

### 1. Self-Reflection 단계 삽입

> 모델이 생성한 결과를 **스스로 평가**하고, 문제가 있다면 수정 기회를 주는 방식

#### 예시:

- 프롬프트에 아래 문장 추가:
    
    > "이제 너가 쓴 문단을 읽고 다음을 검토해:  
    > ① 캐릭터의 말투가 ~해요/~어요 체인가?  
    > ② 질문은 문단 내용과 연결되었는가?  
    > ③ 선택지는 문맥을 자연스럽게 이어가도록 구성되었는가?  
    > 위 조건에 어긋난 부분이 있다면 수정해줘."
    

#### 기대 효과:

- 말투 이탈, 질문-문단 불일치, 무리한 선택지 등 **자동 보완** 가능
    

---

### 2. Rewriting Pass (재귀 프롬프트)

> 한 번 생성한 결과를 다시 요약 → 그 요약을 기반으로 **재생성**하는 재귀 구조

#### 적용 위치:
- `[문장]` 생성 후 요약: "이 문단의 핵심은 무엇인가요?"
- 그 핵심 요약을 가지고 다시 자연스럽게 전개되도록 문장 재작성
#### 기대 효과:
- 이야기의 맥락 유지 강화
- 부자연스러운 전개 / 논리적 오류 완화
    

---

### 3. Role Reflection (역할 전환 디버깅)

> 시스템 역할을 "어린이 독자", "동화 작가", "편집자" 등으로 바꾸며 **다각도 점검**

#### 예시:

- "너는 이제 동화책 편집자야. 방금 쓴 문단에서 말투나 구성상 부적절한 부분을 찾아줘."
    

#### 기대 효과:
- 지나치게 일관된 시각에서 생기는 오류 완화
- 스타일/톤/구성 문제 **다중 관점에서 검토**
    
---

### 4. Partial Constraint Relaxation (선택적 제약 완화)

> 프롬프트에서 **중복되거나 과도한 제약 조건을 조건부로 완화**해 모델 자유도 확보

#### 예시:
- 기존: "절대 새로운 캐릭터 등장 금지"
- 개선: "절대 등장 금지 → 단, 이전 캐릭터와 직접 연결되면 예외 허용"
    

#### 기대 효과:
- 창의성 제한 최소화
- **기획 의도 내 자율성 확보**
    

---

### 5. 페이싱 조절 및 리듬 힌트 삽입

> 문단마다 감정 변화나 긴장-완화 리듬을 **암묵적으로 유도**

#### 방법:

- `get_paragraph_hint()` 내에 아래 추가:
    > "이번 문단은 긴장감을 살짝 낮추고 감정적 연결을 강화해줘."  
    > "이번 문단은 극적인 전환이 필요해. 사건 전개 속도를 높여줘."



<br>


## ✅ 전체 기능 목표 및 서비스 방향

| 기능 영역           | 설명                                                    |
| --------------- | ----------------------------------------------------- |
| 1. 사용자 초기 입력 수집 | 자녀 정보, 관심사, 교육 가치관, 주제 등                              |
| 2. Q&A 기반 동화 생성 | LangGraph 기반 대화 플로우에서 동화 생성                           |
| 3. TTS 낭독 기능    | 생성된 동화를 음성으로 읽어줌                                      |
| 4. STT 기능       | 사용자의 음성을 텍스트로 변환                                      |
| 5. 웹페이지 제작      | 전체 서비스를 사용자와 연결하는 UI/UX                               |
| 6. 추천 시스템       | 자녀 정보 및 이용 이력 기반 맞춤형 동화 추천 기능 콘텐츠 기반 및 협업 필터링 알고리즘 적용 |
| 7. 이미지 생성       | 이야기 장면 삽화 생성 (후순위)                                    |
| 8. 콘텐츠 필터링      | 민감 내용 자동 감지 및 제외 (후순위)                                |
| 9. 동화 랭킹 시스템    | 사용자 선호도 기반 동화 추천/랭킹 (후순위)                             |
| 10. 영상 생성       | 동화 내용을 이미지 및 음성으로 영상화 (후순위)                           |

<br>

---

<br>

## 📋 프로젝트를 위한 체크 리스트

| 단계   | 아이콘 | 항목                  | 세부 내용                                                                                                                                                          |
| ---- | --- | ------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1단계  | ✅   | 데이터 수집 조사           | 공개 동화, 아동 소설, 일러스트 데이터 수집 가능 사이트 조사 (AI Hub, 국립도서관, Gutenberg 등)                                                                                               |
| 2단계  | ✅   | GitHub 초기 세팅        | 개인 폴더 생성 및 파일 업로드 테스트 (DongHwa 저장소 기준)                                                                                                                         |
| 3단계  | ✅   | 라이브러리 조사            | - 주요 기능별 라이브러리 조사 (생성형 AI, TTS, STT, 벡터 DB, LangChain 등) - Python 버전 호환성 확인 (v3.11) - 음성 처리용 Whisper 및 Django 연동 가능 여부 점검 - Next.js 프론트엔드와 Python 백엔드 연동 방법 검토 |
| 4단계  | ✅   | ERD 설계              | 사용자 입력, 동화 생성, 피드백, 이미지, 랭킹 등 테이블 구조 정의                                                                                                                        |
| 5단계  | ✅   | 벡터 DB 구조 설계         | LangChain 기반 벡터 DB 및 Context 검색 최적화                                                                                                                            |
| 6단계  | ✅   | 와이어프레임 제작           | Figma 기반 사용자 입력 UI, 동화 생성 결과, TTS 플레이어 등 UX 흐름 시각화                                                                                                             |
| 7단계  | ✅   | 프롬프트 구조 설계          | 공통/개인화/이미지 생성용 프롬프트 구조 및 패턴 정의                                                                                                                                 |
| 8단계  | ✅   | LangGraph-LLM 연동 실험 | LangGraph와 Gemini 연동, Context 전달 방식 테스트                                                                                                                        |
| 9단계  | ✅   | JSON 구조 정의          | 사용자 입력을 Context로 넘기기 위한 JSON 스키마 설계                                                                                                                            |
| 10단계 | 📌  | 머신러닝 모델 개발          | KoBERT 기반 키워드 분류기 개발, 컨텐츠 기반 협업 필터링 이용 추천서비스 개발 및 서버 API화                                                                                                      |
| 11단계 | 🔄  | LLM 고도화 연동          | 동화 생성 시 ML 키워드 분석 결과를 기반으로 LLM 튜닝                                                                                                                              |
| 12단계 | 🔄  | Voice-to-Voice 연동   | Django 백엔드에 Whisper 등 음성처리(STT) 라이브러리 연동 및 테스트                                                                                                                 |
| 13단계 | ✅   | TTS/STT API 연동 테스트  | Google TTS, CLOVA Voice, Whisper 등 API 테스트 및 음성처리 체계 구축                                                                                                        |
| 14단계 | 📌  | 파일 저장 구조 정의         | 생성 텍스트, 이미지, 피드백, PDF 저장 및 관리 구조 설계                                                                                                                            |
| 15단계 | 📌  | 프로토타입 제작            | 개발 결과물 기반 프로토타입 구현 및 팀 피드백 수집                                                                                                                                  |
| 16단계 | 📌  | UI/UX 개선 및 고도화      | 프로토타입 피드백 반영 및 디자인 고도화                                                                                                                                         |