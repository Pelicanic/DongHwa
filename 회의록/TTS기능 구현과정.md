# 📚 동화책 전체 스토리 TTS 생성 기능

---

## 🧪 1차 시도: 음성 클로닝 기반 TTS

- **목표**: 부모님의 목소리를 녹음하여 클로닝하고, 클로닝된 목소리로 동화를 읽어주는 TTS 생성  
- **사용 도구**: Coqui TTS  

### 진행 과정

- 음성 클로닝에는 성공(5개의 소스를 사용해 각각의 임베딩파일을 생성후 평균값으로 블렌딩)  
- **문제**: GPU 없이 CPU 기반에서는 임베딩 및 음성 합성에 매우 오랜 시간 소요  
  → 임베딩은 최초 1회만 수행하도록 분리 및 캐싱하여 일부 개선  
- 그러나 여전히 처리 속도 느림  
- 감정을 살린 자연스러운 낭독에는 추가 학습이 필요했지만 현실적으로 불가능하다고 판단  
- Coqui TTS 외에 다른 라이브러리를 사용하려 했으나 GPU 없이는 사용제한(Colab gpu 활용하려 했으나 시스템적으로 막혀있음)  
- 클로닝에 필요한 원본 소스를 확보하기 어려움(잡음제거, 분명한 한국어 발음으로 30초 이상 녹음, 최소 5개의 파일이 필요)
> **결론**: 클로닝 방식은 현실적인 제약으로 인해 중단  

---

## 🔁 2차 시도: 클로닝 포기 → 생동감 있는 TTS에 집중

- **TTS**: 네이버 Clova Voice  
- **감정 분석**: Clova Studio (Playground)  

### 핵심 아이디어

- Clova Voice는 일부 화자에 대해 감정 표현, 피치, 속도 조절 가능  
- Clova Studio에서 문장 감정을 분석하여 각 문장에 알맞은 낭독 스타일 정보를 JSON으로 추출  

### 결과

- 자연스러운 TTS 생성 가능  
- **문제**: Clova Studio의 API 사용 시 토큰 소모가 심각하게 큼  

---

## 🧠 3차 시도: Google Cloud TTS + Gemini 감정 분석

- **TTS**: Google Cloud Text-to-Speech (SSML 지원)  
- **감정 분석**: Google Gemini  

### 핵심 아이디어

- Gemini로 문장의 감정을 분석 후, SSML 태그를 동적으로 생성  
- SSML을 활용해 호흡, 높낮이, 말투 등을 조절  

### 결과

- 감정 분석은 잘 작동하고, 토큰 소모도 낮음  
- **문제**: Google TTS의 한국어 발음 품질이 낮고, 발음이 뭉개짐  

---

## ✅ 4차 시도: Clova Voice + Gemini 감정 분석 (최종 채택)

- **TTS**: 네이버 Clova Voice  
- **감정 분석**: Google Gemini  

### 핵심 아이디어

- Gemini가 각 문장의 감정을 분석하고, Clova Voice에서 사용 가능한 파라미터(화자, 속도, 피치, 볼륨 등)를 JSON으로 반환  

### 결과

- 감정 분석 결과를 기반으로 자연스러운 낭독 가능  
- Clova Voice의 뛰어난 한국어 발음 + Gemini의 저렴한 감정 분석 → **품질과 비용 모두 만족**  

---

## 📈 전체 TTS 기능 흐름

1. **사용자 로그인**
   - JWT 인증 기반, 로그인한 유저의 `user_id`로 접근 가능한 `StoryID` 확보

2. **동화 불러오기**
   - 특정 `StoryID`로 DB에서 동화 본문(P11~20) 로드

3. **문장 분리**
   - `kss` 라이브러리로 문장 단위 분리 (대사, 내레이션 포함)

4. **감정 분석**
   - Gemini로 각 문장에 대해 감정, 화자, 속도, 피치, 볼륨 분석 → JSON 반환

5. **TTS 생성**
   - Clova Voice로 문장 단위 음성 합성 (분석 결과 기반)

6. **음원 합치기**
   - 세그먼트별 MP3를 하나의 전체 음원으로 병합, 중간 파일은 삭제

---

## 🎧 추가 기능: AI 질문 스트리밍 TTS

> 현재는 **백엔드 구현 완료**, 프론트 구현 예정

### 기능

- 동화 중간에 삽입된 AI 질문(`ai_question`)을 실시간으로 낭독

### 작동 방식

1. JWT 인증 상태 확인  
2. `qa_id`로 ParagraphQA 항목 조회  
3. 해당 질문이 유저의 동화에 속하는지 검증  
4. 질문 텍스트를 Clova Voice에 전송 → MP3 음성 생성  
5. `StreamingHttpResponse`로 MP3 데이터를 반환 → 실시간 재생 지원
